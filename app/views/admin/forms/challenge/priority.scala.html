@import org.maproulette.models.Challenge
@import views.html.admin.forms.elements._
@(challengeForm:Form[Challenge])(implicit messages: Messages)
<span class="help-block">@messages("challenge.wizard.priority.description")</span>
@select(challengeForm("defaultPriority"),
    label = messages("challenge.wizard.priority.default.label"),
    optionList = List((messages("challenge.wizard.priority.expression.high"), "0"), (messages("challenge.wizard.priority.expression.medium"), "1"), (messages("challenge.wizard.priority.expression.low"), "2")),
    isMultiple = false,
    help = messages("challenge.wizard.priority.default.help"),
    defaultSelected = Some("0")
)
<div class="form-group">
    <div class="col-sm-2"></div>
    <span class="col-sm-8 help-block">@messages("challenge.wizard.priority.expression.description")</span>
</div>
<div class="form-group">
    <label class="col-sm-2 control-label">@messages("challenge.wizard.priority.expression.high")</label>
    <div id="priority-high-builder" class="col-sm-8"></div>
</div>
<input type="text" readonly="readonly" id="highPriorityRule" name="highPriorityRule" style="display:none"/>
<div class="form-group">
    <label class="col-sm-2 control-label">@messages("challenge.wizard.priority.expression.medium")</label>
    <div id="priority-medium-builder" class="col-sm-8"></div>
</div>
<input type="text" readonly="readonly" id="mediumPriorityRule" name="mediumPriorityRule" style="display:none"/>
<div class="form-group">
    <label class="col-sm-2 control-label">@messages("challenge.wizard.priority.expression.low")</label>
    <div id="priority-low-builder" class="col-sm-8"></div>
</div>
<input type="text" readonly="readonly" id="lowPriorityRule" name="lowPriorityRule" style="display:none"/>
<script type="application/javascript">
$().ready(function() {
    var highRule = '@challengeForm("highPriorityRule").value.getOrElse("")'.split("&quot;").join("\"");
    if (highRule != "" && highRule != "{}") {
        $('#priority-high-builder').queryBuilder('setRules', JSON.parse(highRule));
    }
    var mediumRule = '@challengeForm("mediumPriorityRule").value.getOrElse("")'.split("&quot;").join("\"");
    if (mediumRule != "" && mediumRule != "{}") {
        $('#priority-medium-builder').queryBuilder('setRules', JSON.parse(mediumRule));
    }
    var lowRule = '@challengeForm("lowPriorityRule").value.getOrElse("")'.split("&quot;").join("\"");
    if (lowRule != "" && lowRule != "{}") {
        $('#priority-low-builder').queryBuilder('setRules', JSON.parse(lowRule));
    }
});

var generalFilters = [{
    id: 'tag',
    label: 'Tag',
    input: function(rule, name) {
        var hidden = '';
        if (rule.operator.type === 'is_empty' && rule.operator.type === 'is_not_empty') {
            hidden = 'style="display:none"'
        }
        return '\
                <input type="text" class="form-control top-item" name="' + name + '_key" placeholder="Key"/> = \
                <input type="text" class="form-control top-item" name="' + name + '_value" placeholder="Value" ' + hidden + '/>';
    },
    valueGetter: function(rule) {
        return rule.$el.find('.rule-value-container [name$=_key]').val()
                +'.'+ rule.$el.find('.rule-value-container [name$=_value]').val();
    },
    valueSetter: function(rule, value) {
        if (rule.operator.nb_inputs > 0) {
            var val = value.split('.');

            rule.$el.find('.rule-value-container [name$=_key]').val(val[0]).trigger('change');
            rule.$el.find('.rule-value-container [name$=_value]').val(val[1]).trigger('change');
        }
    }
}];

var general = {
    plugins: ['bt-tooltip-errors'],
    operators:[
        {type: 'equal', multiple:false, apply_to: ['string']},
        {type: 'not_equal', multiple:false, apply_to: ['string']},
        {type: 'contains', multiple:false, apply_to: ['string']},
        {type: 'not_contains', multiple:false, apply_to: ['string']},
        {type: 'is_empty', nb_inputs: 1, multiple:false, apply_to: ['string']},
        {type: 'is_not_empty', nb_inputs: 1, multiple:false, apply_to: ['string']}
    ],
    allow_groups:false,
    allow_empty:true,
    filters:generalFilters,
    select_placeholder: '@messages("challenge.wizard.priority.expression.none")',
    lang_code: '@messages.lang.language'
};

$('#priority-high-builder').queryBuilder(general);
$('#priority-medium-builder').queryBuilder(general);
$('#priority-low-builder').queryBuilder(general);
</script>
